define(["jquery","local_vmchat/chatboxManager","local_vmchat/iolib"],function(a,b,c){var d={};return d.memberUpdate=function(b){var d=b.message;if("undefined"==typeof wwwroot)var e="./images/online.png";else var e=wwwroot+"local/vmchat/bundle/chat/images/online.png";if(d.length>0){var f=d.length-1;a("#user_list .inner_bt #usertab_icon").css({background:"url("+e+")no-repeat top left"})}if(a("#user_list .inner_bt #usertab_text").text(lang.whos+" ("+f+")"),a("#chatroom_bt .inner_bt #chatroom_text").text(lang.chatroom+" ("+f+")"),d.length>1){if(!document.getElementById("chat_div")){var g=document.createElement("div");g.id="chat_div",document.body.appendChild(g)}a("#chat_div").memberlist({id:"chat_div",user:d,offset:"37px",title:lang.online,userSent:function(b){a("#chat_div").memberlist("option","boxManager").addUsr(b)}}),a("#chat_div .ui-memblist-usr").remove(),a.each(d,function(b,d){d.userid!=c.cfg.userid&&a("#chat_div").memberlist("option").userSent(d)})}else a("div#memlist").length&&a("div#memlist").remove()},d.messageUpdate=function(d){if(a.isPlainObject(d.message))var e=d.message.msg;else var e=d.message;var f=d.toUser,g=d.fromUser,h=c.cfg.userid,i=(new Date).getTime();if("chatroom"!=d.message.receiver||""!=f&&void 0!=f){if(void 0!=f&&""!=f){if(h==f.userid&&g.userid!=h){a.inArray(g.userid,idList)==-1&&(counter++,idList.push(g.userid),vmstorage[g.userid]=[],vmstorage[g.userid].push({userid:g.userid,name:g.name+" "+g.lname})),b.addBox(g.userid,{dest:"dest"+counter,title:"box"+counter,first_name:g.name,last_name:g.lname});g.userid;b.init({user:g,messageSent:function(b,c,d){a("#"+b).chatbox("option","boxManager").addMsg(c.name,d)}}),a("#"+g.userid).chatbox("option").messageSent(g.userid,g,e),a("li[aria-controls='tabcb"+g.userid+"']").addClass("ui-state-highlight");var j=g.userid}vmstorage[j].push({userid:g.userid,name:g.name,msg:e,time:i})}}else{if(h==g.userid)a("#chat_room").chatroom("option").messageSent(g,e);else if(chatroombox)a("#chat_room").chatroom("option").messageSent(g,e);else{if(0==a("div#chat_room").length){var k=document.createElement("div");k.id="chat_room",document.body.appendChild(k),chatroombox=a("#chat_room").chatroom({id:"chat_room",user:g,title:lang.chatroom_header,messageSent:function(b,c){a("#chat_room").chatroom("option","boxManager").addMsg(b.name,c)}})}a("#chat_room").chatroom("option").messageSent(g,e)}if(null!=sessionStorage.getItem("chatroom")){var l=JSON.parse(sessionStorage.getItem("chatroom")),m={userid:g.userid,name:g.name,msg:e,time:i};l.push(m),sessionStorage.setItem("chatroom",JSON.stringify(l))}else sessionStorage.setItem("chatroom",JSON.stringify([{userid:g.userid,name:g.name,msg:e,time:i}]))}},d.statusUpdate=function(b,c,d){a("#"+b.userid).length&&(a("#"+b.userid).chatbox("option").messageSent(b.userid,b,c),a("#ta"+b.userid).prop("disabled",d))},d.common_chatbox_update=function(b,c){a("div#chat_room").length&&a("#chat_room").chatroom("option").messageSent(b,c)},d.newStatus=function(b){a.each(b.message,function(a,c){null!=b.newuser&&c.userid==b.newuser&&(statusUpdate(c,"Online",!1),common_chatbox_update(c,"Online"))})},d.createTab=function(b,c){var e=a("#tabs").tabs(),f=a("div#tabs ul li").length;tabId="tabcb"+b,d.addTab(e,tabId,f,c)},d.addTab=function(b,c,d,e){var f=a("#tab_content"),g="<li id = '"+c+"' class = 'ui-state-default ui-corner-bottom ui-tabs-active ui-state-active' aria-controls = '"+c+"'><a href = '#{href}' class = 'ui-tabs-anchor'>#{label}</a> <a href = '#' role = 'button'class = 'ui-corner-all ui-chatbox-icon'><span class = 'ui-icon ui-icon-close'>close</span></a></li>",h=e||"Tab "+d,c=c,i=a(g.replace(/#\{href\}/g,"#"+c).replace(/#\{label\}/g,h));f.val()||"Tab "+d+" content.";b.find(".ui-tabs-nav").append(i)},d.browserSupportsLocalStorage=function(){return"localStorage"in window&&null!=window.localStorage},d.displaycomChatHistory=function(){if(sessionStorage.length>0){var b=document.createElement("div");b.id="chat_room",document.body.appendChild(b);var c=JSON.parse(sessionStorage.getItem("chatroom"));a.each(c,function(b,c){b<1&&(chatroombox=a("#chat_room").chatroom({id:"chat_room",user:c,title:"Common chat",messageSent:function(b,c){a("#chat_room").chatroom("option","boxManager").addMsg(b.name,c)}})),a("#chat_room").chatroom("option").messageSent(c,c.msg)})}"hidden"==sessionStorage.getItem("chatroom_status")&&a("#chatrm").hide()},d.displayChatHistory=function(){if(null!=localStorage.getItem(sid)){var c=JSON.parse(localStorage.getItem(sid));a.each(c,function(c,d){counter++,idList.push(c),a.each(d,function(d,e){d<1?(b.addBox(c,{dest:"dest"+counter,title:"box"+counter,first_name:e.name}),b.init({messageSent:function(b,c,d){a("#"+b).chatbox("option","boxManager").addMsg(c.name,d)}})):a("#"+c).chatbox("option").messageSent(c,e,e.msg)}),"hidden"==localStorage.getItem(c)&&(a("#cb"+c).hide(),a("#tabcb"+c).removeClass("ui-state-active"))})}},d.display_error=function(b){a("<div id = 'dialog' title = 'VmChat Error:'></div>").prependTo("#stickybar"),a("#dialog").html(b),a("#dialog").dialog()},d.isIosDevices=function(){var a=navigator.userAgent,b=/iPad/i.test(a)||/iPhone OS 3_1_2/i.test(a)||/iPhone OS 3_2_2/i.test(a);return b},d});