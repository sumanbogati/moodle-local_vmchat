define(["jquery"],function(a){var b={cfg:{},sock:null,wsuri:null,error:null,uniquesids:null,init:function(a,b){this.cfg=a,this.wsconnect()},wsconnect:function(){b.wsuri=this.cfg.rid,console.log(this.cfg.rid),"WebSocket"in window?this.sock=new WebSocket(b.wsuri):"MozWebSocket"in window?this.sock=new MozWebSocket(b.wsuri):(console.log("Browser does not support WebSocket!"),this.error=lang.wserror);var c=this;this.sock.onopen=function(){console.log("Connected to "+c.cfg.rid),a.event.trigger({type:"connectionopen"}),c.userauthenticat(),c.addclient()},this.sock.binaryType="arraybuffer",this.sock.onmessage=function(b){if(b.data instanceof ArrayBuffer)a.event.trigger({type:"binrec",message:b.data});else{var d=JSON.parse(b.data);if("joinroom"==d.type){console.log("New user join room "+d.users);var e=null;null!=c.uniquesids&&a.each(d.clientids,function(a,b){void 0==c.uniquesids[a]&&(e=a)}),c.uniquesids=d.clientids,a.event.trigger({type:"member_added",message:d.users,newuser:e})}if("broadcastToAll"==d.type){console.log("json  : display msg");var f="";void 0!=d.userto&&(f=d.userto),a.event.trigger({type:"newmessage",message:d.m,fromUser:d.user,toUser:f})}if("userleft"==d.type){console.log("user logout");var f="";void 0!=d.userto&&(f=d.userto),null!=c.uniquesids&&delete c.uniquesids[d.user.userid],a.event.trigger({type:"user_logout",fromUser:d.user,message:"offline",toUser:f})}"leftroom"==d.type&&(console.log("member removed"),a.event.trigger({type:"member_removed",message:d.users})),"Unauthenticated"==d.type&&(console.log("Unauthenticated user"),a.event.trigger({type:"authentication_failed",message:"Authentication failed"})),"Multiple_login"==d.type&&(console.log("Multiple_login"),a.event.trigger({type:"Multiple_login"}))}},this.sock.onerror=function(b){c.error=b,console.log("Error:"+b),a.event.trigger({type:"error",message:b})},this.sock.onclose=function(b){console.log("Connection Closed"),a.event.trigger({type:"connectionclose",message:b.reason}),console.log("Connection closed (wasClean = "+b.wasClean+", code = "+b.code+", reason = '"+b.reason+"')"),setTimeout(function(){c.wsconnect()},5e3)}},userauthenticat:function(){var a={cfun:"authenticate",arg:{authuser:this.cfg.authuser,authpass:this.cfg.authpass}},b=JSON.stringify(a);this.sock.send(b)},addclient:function(){var a={cfun:"joinroom",arg:{client:this.cfg.userid,roomname:this.cfg.room,user:this.cfg.userobj}},b=JSON.stringify(a);this.sock.send(b)},send:function(a){var b={cfun:"broadcastToAll",arg:{msg:a}};if(arguments.length>1){var c=arguments[1];b.arg.touser=this.uniquesids[c]}var d=JSON.stringify(b);this.sock.send(d)},sendBinary:function(a){this.sock.send(a.buffer)},disconnect:function(){this.sock.onclose=function(){},this.sock.close(),console.log("i am closing this connection")}};return b});